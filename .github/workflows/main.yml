name: Deploy to EC2 with Docker

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_IMAGE: naveenlankesha/blogsl-frontend    # Your Docker Hub repo
  CONTAINER_NAME: blogsl-frontend-container       # Container name
  EC2_HOST: 56.228.15.145                         # EC2 public IP
  EC2_USER: ubuntu                                # Default user (Amazon Linux -> ec2-user)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 2. Build and Push image to Docker Hub
    - name: Build and Push Docker Image
      run: |
        IMAGE_TAG=${GITHUB_SHA}
        docker build -t $DOCKER_IMAGE:$IMAGE_TAG .
        docker push $DOCKER_IMAGE:$IMAGE_TAG
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    # 3. Deploy on EC2 using SSH
    - name: Deploy on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.EC2_HOST }}
        username: ${{ env.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}   # EC2 private key (PEM contents)
        script: |
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker pull $DOCKER_IMAGE:${{ env.IMAGE_TAG }}
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
          docker run -d --name $CONTAINER_NAME -p 3000:3000 $DOCKER_IMAGE:${{ env.IMAGE_TAG }}
